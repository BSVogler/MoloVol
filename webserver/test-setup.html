<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MoloVol WASM Test</title>
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: system-ui, sans-serif;
        }
        .parameters input[type="number"] {
            width: 100px;
            margin-right: 10px;
        }
        .output {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>MoloVol WASM Test</h1>
    
    <form id="molovolForm">
        <div class="file-upload">
            <label for="structure">Upload structure file (XYZ, PDB, or CIF)</label><br>
            <input type="file" id="structure" accept=".xyz,.cif,.pdb" required>
        </div>

        <div class="parameters">
            <input type="number" id="probe_radius_small" name="probe_radius_small" step="0.1" required value="1.2" min="0.1">
            <label for="probe_radius_small">Small probe radius (Å)</label><br>

            <input type="number" id="grid_resolution" name="grid_resolution" step="0.1" required value="0.2" min="0.1">
            <label for="grid_resolution">Grid spacing (Å)</label><br>

            <input type="number" id="probe_radius_large" name="probe_radius_large" step="0.1" min="0">
            <label for="probe_radius_large">Large probe radius (Å) - Optional</label><br>
            
            <input type="number" id="tree_depth" name="tree_depth" step="1" value="4" min="1">
            <label for="tree_depth">Tree depth</label><br>
        </div>

        <div class="options">
            <input type="checkbox" id="include_hetatm" name="include_hetatm" checked>
            <label for="include_hetatm">Include HETATM</label><br>

            <input type="checkbox" id="unit_cell" name="unit_cell">
            <label for="unit_cell">Analyze unit cell</label><br>

            <input type="checkbox" id="surface_area" name="surface_area">
            <label for="surface_area">Calculate surface areas</label><br>
        </div>

        <button type="submit">Calculate</button>
    </form>

    <div id="output" class="output"></div>

    <script type="module">
        // Import the WASM module
        import createMoloVolModule from './molovol_wasm.js';

        let wasmModule;
        let calculationOutput = [];

        // Initialize the WASM module
        const moduleConfig = {
            preRun: [],
            postRun: [],
            print: (text) => {
                console.log(text);
                calculationOutput.push(text);
                updateOutput();
            },
            printErr: (text) => {
                console.error(text);
                calculationOutput.push(`Error: ${text}`);
                updateOutput();
            },
            locateFile: (path) => './' + path,
            EXPORTED_RUNTIME_METHODS: ['FS', 'callMain']
        };

        function updateOutput() {
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = calculationOutput.join('\n');
        }

        // Create a global Module object that will be used by the WASM code
        window.Module = moduleConfig;

        createMoloVolModule(moduleConfig).then(module => {
            wasmModule = module;
            console.log('WASM module loaded');
        }).catch(err => {
            console.error('Failed to load WASM module:', err);
        });

        document.getElementById('molovolForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!wasmModule) {
                alert('WASM module not yet loaded');
                return;
            }

            const outputDiv = document.getElementById('output');
            // Clear previous output
            outputDiv.textContent = '';

            try {
                // Validate the file
                const structureFile = document.getElementById('structure').files[0];
                const validExtensions = ['.xyz', '.cif', '.pdb'];
                const fileExtension = '.' + structureFile.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    throw new Error(`Invalid file type. Please use one of: ${validExtensions.join(', ')}`);
                }
                
                // Get file content
                const fileContent = await structureFile.text();
                
                // Create calculation parameters object
                const params = {
                    probe_radius_small: parseFloat(document.getElementById('probe_radius_small').value),
                    grid_resolution: parseFloat(document.getElementById('grid_resolution').value),
                    structure_content: fileContent,
                    probe_radius_large: parseFloat(document.getElementById('probe_radius_large').value || "0"),
                    tree_depth: parseInt(document.getElementById('tree_depth').value),
                    include_hetatm: document.getElementById('include_hetatm').checked,
                    unit_cell: document.getElementById('unit_cell').checked,
                    surface_area: document.getElementById('surface_area').checked,
                    export_report: false,
                    export_total_map: false,
                    export_cavity_maps: false
                };

                // Validate required parameters
                if (params.probe_radius_small <= 0) {
                    throw new Error('Small probe radius must be positive');
                }
                if (params.grid_resolution < 0.1) {
                    throw new Error('Grid spacing must be at least 0.1');
                }

                const result = wasmModule.calculate_volumes(params);
                
                // Only add failure message if needed - success details are already in the output
                if (!result.success) {
                    outputDiv.textContent += '\nCalculation failed';
                }
                
            } catch (err) {
                outputDiv.textContent += `Error: ${err.message}\n`;
                console.error(err);
            }
        });
    </script>
</body>
</html>